{% extends "ru/base.html" %}

{% block title %}Игра{% endblock %}

{% block content %}
{% raw %}
<div id="game-app" v-cloak class="container mx-auto p-4">
  <!-- Header: Show Room Code and Save/Load buttons -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <button @click="copyRoomCode" 
              @mouseleave="resetCopyState"
              class="group relative flex items-center gap-2 text-amber-100 hover:text-amber-50 transition-colors">
        <span class="medieval text-xl">Код комнаты: </span>
        <span class="font-mono text-xl text-amber-300 hover:text-amber-200">{{ room.room_id }}</span>
        <span v-if="!codeCopied && !wasJustCopied" 
              class="absolute -bottom-8 left-0 text-sm text-amber-200 opacity-0 group-hover:opacity-100 transition-opacity">
          Нажмите, чтобы скопировать
        </span>
        <span v-if="codeCopied" 
              class="absolute -bottom-8 left-0 text-sm text-emerald-400 transition-opacity"
              :class="{ 'opacity-100': codeCopied, 'opacity-0': !codeCopied }">
          Скопировано!
        </span>
      </button>
    </div>
    <div class="space-x-2">
      <button @click="saveGame" class="bg-teal-600 hover:bg-teal-500 px-4 py-2 rounded-lg medieval text-amber-50 transition-colors">Сохранить</button>
      <button @click="loadGame" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg medieval text-amber-50 transition-colors">Загрузить</button>
      <button @click="leaveRoom" class="bg-stone-600 hover:bg-stone-500 px-4 py-2 rounded-lg medieval text-amber-50 transition-colors">Выйти</button>
    </div>
  </div>

  <!-- Players in Room Section with Stats -->
  <div class="mb-6">
    <div class="flex justify-between items-center mb-3">
      <h2 class="medieval text-2xl text-amber-100">Игроки в комнате</h2>
      <button @click="togglePlayers" class="text-amber-200 hover:text-amber-100 transition-colors flex items-center gap-2">
        <span class="text-sm">{{ showPlayers ? 'Скрыть игроков' : 'Показать игроков' }}</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" :class="{ 'rotate-180': !showPlayers }" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
    <div v-show="showPlayers" class="flex flex-wrap gap-4 transition-all duration-300">
      <div v-for="(player, pid) in room.players" :key="pid" 
           class="flex-grow bg-slate-800 rounded-lg p-4 min-w-[300px] max-w-[400px] border border-slate-700">
        <div class="text-lg font-semibold text-amber-100 mb-3">{{ player.name }}</div>
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-slate-300 text-sm">
          <div><span class="text-amber-200">Раса:</span> {{ player.race }}</div>
          <div><span class="text-amber-200">Класс:</span> {{ player.class_name }}</div>
          <div><span class="text-amber-200">Уровень:</span> {{ player.level }}</div>
          <div><span class="text-amber-200">Здоровье:</span> {{ player.health_points }}</div>
          <div><span class="text-amber-200">Урон:</span> {{ player.damage }}</div>
          <div><span class="text-amber-200">Золото:</span> {{ player.gold }}</div>
          <div class="col-span-2"><span class="text-amber-200">Магия:</span> {{ player.magic_1lvl }}/{{ player.magic_2lvl }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages Section (Expanded) -->
  <div class="mb-6">
    <h2 class="medieval text-2xl text-amber-100 mb-3">Сообщения</h2>
    <div class="h-[400px] overflow-y-auto bg-slate-800 p-4 rounded-lg border border-slate-700" ref="messagesContainer">
      <div v-for="msg in allMessages" :key="msg.id" class="mb-2">
        <span v-if="msg.type === 'system'" class="text-amber-300">Система: {{ msg.message }}</span>
        <span v-else-if="msg.type === 'dm'" class="text-emerald-400">ДМ: {{ msg.message }}</span>
        <span v-else-if="msg.type === 'thinking'" class="text-emerald-400 flex items-center gap-2">
          ДМ думает
          <span class="inline-flex gap-1">
            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
          </span>
        </span>
        <span v-else class="text-sky-300">{{ msg.player_name }}: {{ msg.message }}</span>
      </div>
    </div>
  </div>

  <!-- Action Input Section -->
  <div class="flex gap-2 mb-6">
    <template v-if="diceNeeded">
      <div class="flex-grow flex items-center px-4 py-2 rounded-lg bg-slate-800 text-slate-300 border border-slate-700">
        Пожалуйста, бросьте {{ diceType }}
      </div>
      <button @click="rollDice" 
              :disabled="diceRolling"
              class="px-6 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg medieval text-amber-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
        <span>Бросить {{ diceType }}</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
        </svg>
      </button>
    </template>
    <template v-else>
      <input v-model="userInput" 
             placeholder="Введите ваше действие" 
             class="flex-grow px-4 py-2 rounded-lg bg-slate-800 text-slate-100 border border-slate-700 focus:border-amber-500 focus:outline-none" 
             @keyup.enter="sendMessage">
      <button @click="sendMessage" 
              :disabled="isLoading"
              class="px-6 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg medieval text-amber-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
        <span>Отправить</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
        </svg>
      </button>
    </template>
  </div>

  <!-- Dice Roll Popup Modal -->
  <div v-if="diceNeeded" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full border border-slate-700">
      <h3 class="medieval text-2xl mb-4 text-amber-100">Требуется бросок кубика</h3>
      <p class="mb-4 text-slate-300">Пожалуйста, бросьте {{ diceType }}.</p>
      <button @click="rollDice" 
              :disabled="diceRolling" 
              class="w-full bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded-lg medieval text-amber-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        Бросить {{ diceType }}
      </button>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      gameState: {},
      messages: [],
      pendingMessage: null,
      userInput: '',
      isLoading: false,
      diceNeeded: false,
      diceType: 'd20',
      room: {},
      diceRolling: false,
      showPlayers: true,
      codeCopied: false,
      wasJustCopied: false,
      isThinking: false
    };
  },
  computed: {
    allMessages() {
      let result = [...this.messages];
      if (this.pendingMessage) {
        result.push(this.pendingMessage);
      }
      if (this.isThinking) {
        result.push({ id: 'thinking', type: 'thinking' });
      }
      return result;
    }
  },
  methods: {
    resetCopyState() {
      if (this.codeCopied) {
        this.wasJustCopied = true;
      } else {
        this.wasJustCopied = false;
      }
    },
    async copyRoomCode() {
      if (!this.room.room_id) return;
      
      try {
        await navigator.clipboard.writeText(this.room.room_id);
        this.codeCopied = true;
        setTimeout(() => {
          this.codeCopied = false;
        }, 2000);
      } catch (err) {
        console.error('Failed to copy room code:', err);
      }
    },
    togglePlayers() {
      this.showPlayers = !this.showPlayers;
    },
    async sendMessage() {
      if (!this.userInput.trim()) return;
      
      // Add pending message immediately
      this.pendingMessage = {
        id: 'pending',
        type: 'player',
        message: this.userInput,
        player_name: this.gameState.name || 'Вы'
      };
      
      // Show thinking indicator
      this.isThinking = true;
      
      this.isLoading = true;
      try {
        const response = await fetch('/game_action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: this.userInput })
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
        } else {
          this.gameState = data.player;
          if (data.room) {
            this.room = data.room;
          }
          if (data.dice_needed) {
            this.diceNeeded = true;
            this.diceType = data.dice_type || 'd20';
          } else {
            this.diceNeeded = false;
          }
          if (data.messages) {
            this.messages = data.messages;
          }
          this.userInput = '';
        }
      } catch (e) {
        console.error(e);
      } finally {
        this.isLoading = false;
        this.pendingMessage = null;
        this.isThinking = false;
      }
    },
    async rollDice() {
      if (this.diceRolling) return;
      
      // Show thinking indicator immediately
      this.diceRolling = true;
      this.isThinking = true;
      
      try {
        const rollResponse = await fetch('/roll_dice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dice_type: this.diceType })
        });
        const rollData = await rollResponse.json();
        if (rollData.error) {
          alert(rollData.error);
          return;
        }
        
        // Add roll message immediately
        this.pendingMessage = {
          id: 'pending-roll',
          type: 'player',
          message: `бросил ${rollData.roll} на ${rollData.dice_type}`,
          player_name: this.gameState.name || 'Вы'
        };
        
        const processResponse = await fetch('/process_roll', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roll: rollData.roll, dice_type: rollData.dice_type })
        });
        const processData = await processResponse.json();
        if (processData.error) {
          alert(processData.error);
        } else {
          this.gameState = processData.player;
          if (processData.messages) {
            this.messages = processData.messages;
          }
        }
      } catch (e) {
        console.error(e);
      } finally {
        this.diceRolling = false;
        this.diceNeeded = false;
        this.pendingMessage = null;
        this.isThinking = false;
      }
    },
    async saveGame() {
      try {
        const response = await fetch('/save_game', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        alert(data.message);
      } catch (e) {
        console.error(e);
      }
    },
    async loadGame() {
      try {
        const response = await fetch('/load_game', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.status === 'success') {
          this.gameState = data.room;
          alert(data.message);
        } else {
          alert(data.error || data.message || 'Ошибка загрузки игры');
        }
      } catch (e) {
        console.error(e);
      }
    },
    async leaveRoom() {
      if (!confirm("Вы уверены, что хотите покинуть комнату?")) return;
      try {
        const response = await fetch('/leave_room', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.status === 'success') {
          window.location.href = '/';
        } else {
          alert(data.message || 'Не удалось покинуть комнату.');
        }
      } catch (e) {
        console.error(e);
      }
    },
    async loadInitialState() {
      try {
        const response = await fetch('/get_room_state');
        const data = await response.json();
        if (data.status === 'success') {
          this.gameState = data.room;
          this.messages = data.messages || [];
          this.room = data.room;
        }
      } catch (e) {
        console.error(e);
      }
    }
  },
  watch: {
    allMessages: {
      handler() {
        this.$nextTick(() => {
          if (this.$refs.messagesContainer) {
            this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
          }
        });
      },
      deep: true
    }
  },
  mounted() {
    this.loadInitialState();
  }
}).mount('#game-app');
</script>
{% endraw %}
{% endblock %} 