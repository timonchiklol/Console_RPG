<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Console Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        .medieval {
            font-family: 'MedievalSharp', cursive;
        }
        .game-bg {
            background-image: url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
        }
        .message-box {
            height: 300px;
            overflow-y: auto;
        }
        .stats-box {
            background-color: rgba(0, 0, 0, 0.7);
        }
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    {% raw %}
    <div id="app" class="container mx-auto px-4 py-8" v-cloak>
        <!-- Language Selection -->
        <div v-if="!gameStarted" class="text-center">
            <h1 class="medieval text-5xl mb-8">D&D Console Adventure</h1>
            <div class="space-x-4 mb-8">
                <button @click="startGame('en')" class="bg-red-700 hover:bg-red-600 text-white px-6 py-3 rounded-lg medieval">
                    Start in English
                </button>
                <button @click="startGame('ru')" class="bg-red-700 hover:bg-red-600 text-white px-6 py-3 rounded-lg medieval">
                    Начать на Русском
                </button>
            </div>
            <button @click="showFeedback = true" class="text-gray-400 hover:text-gray-300 underline medieval">
                Feedback
            </button>
        </div>

        <!-- Character Creation -->
        <div v-else-if="!characterCreated" class="max-w-4xl mx-auto">
            <h2 class="medieval text-3xl mb-6">Create Your Character</h2>
            
            <!-- Race Selection -->
            <div class="mb-8">
                <h3 class="medieval text-2xl mb-4">Choose Your Race</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div v-for="(stats, race) in races" 
                         :key="race"
                         @click="selectRace(race)"
                         :class="['p-4 rounded-lg cursor-pointer border-2 transition-all',
                                selectedRace === race ? 'border-red-500 bg-gray-800' : 'border-gray-700 hover:border-gray-500']">
                        <h4 class="medieval text-xl mb-2">{{ race }}</h4>
                        <p class="text-sm text-gray-400">HP: {{ stats.hp }}</p>
                        <p class="text-sm text-gray-400">Damage: {{ stats.damage }}</p>
                        <p class="text-sm text-gray-400">Gold: {{ stats.gold }}</p>
                    </div>
                </div>
            </div>

            <!-- Class Selection -->
            <div class="mb-8">
                <h3 class="medieval text-2xl mb-4">Choose Your Class</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div v-for="(stats, className) in classes" 
                         :key="className"
                         @click="selectClass(className)"
                         :class="['p-4 rounded-lg cursor-pointer border-2 transition-all',
                                selectedClass === className ? 'border-red-500 bg-gray-800' : 'border-gray-700 hover:border-gray-500']">
                        <h4 class="medieval text-xl mb-2">{{ className }}</h4>
                        <p class="text-sm text-gray-400">HP Bonus: +{{ stats.hp_bonus }}</p>
                        <p class="text-sm text-gray-400">Gold Bonus: +{{ stats.gold_bonus }}</p>
                        <p class="text-sm text-gray-400">Magic: {{ stats.magic }}</p>
                    </div>
                </div>
            </div>

            <button @click="createCharacter" 
                    :disabled="!selectedRace || !selectedClass || isCreatingCharacter"
                    :class="['w-full py-3 rounded-lg medieval text-xl transition-all',
                            (!selectedRace || !selectedClass || isCreatingCharacter) ? 'bg-gray-700 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600']">
                {{ isCreatingCharacter ? 'Creating Character...' : 'Begin Adventure' }}
            </button>
        </div>

        <!-- Game Interface -->
        <div v-else class="max-w-6xl mx-auto game-bg rounded-lg p-6">
            <!-- Character Stats -->
            <div class="stats-box rounded-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <h3 class="medieval text-xl text-red-500">Character</h3>
                    <p>{{ gameState.player_race }} {{ gameState.player_class }}</p>
                    <p>Level {{ gameState.level }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">Combat</h3>
                    <p>HP: {{ gameState.health_points }}</p>
                    <p>Damage: {{ gameState.damage }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">Resources</h3>
                    <p>Gold: {{ gameState.gold }}</p>
                    <p>Magic (1st/2nd): {{ gameState.magic_1lvl }}/{{ gameState.magic_2lvl }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">Status</h3>
                    <p>{{ combatStatus }}</p>
                </div>
            </div>

            <!-- Dice Rolling Section -->
            <div v-if="diceNeeded || diceRollPending" class="dice-section bg-gray-800 rounded-lg p-4 mb-4 border-2 border-red-500 text-center">
                <h3 class="medieval text-2xl mb-4 text-red-500">⚄ Dice Roll Required ⚄</h3>
                <p class="mb-4 text-xl">The Dungeon Master requests a {{ displayDiceType }} roll</p>
                <button @click="rollDice" 
                        :disabled="isLoading"
                        class="bg-red-700 hover:bg-red-600 text-white px-8 py-4 rounded-lg text-2xl medieval animate-pulse transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 mb-4">
                    Roll {{ displayDiceType }}
                </button>
                <div v-if="lastRoll" class="mt-4 text-xl">
                    <span class="text-gray-400">Last roll:</span>
                    <span class="text-red-500 font-bold">{{ lastRoll }}</span>
                </div>
            </div>

            <!-- Game Messages -->
            <div class="message-box bg-gray-800 rounded-lg p-4 mb-4">
                <div v-for="(message, index) in messages" :key="index" class="mb-2">
                    <div v-if="message.type === 'user'" class="text-blue-400">
                        You: {{ message.text }}
                    </div>
                    <div v-else-if="message.type === 'system'" class="text-yellow-400">
                        System: {{ message.text }}
                    </div>
                    <div v-else class="text-green-400">
                        DM: {{ message.text }}
                    </div>
                </div>
                <div v-if="isLoading" class="text-gray-400 animate-pulse flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Dungeon Master is thinking...
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <button @click="startCombat" 
                        :disabled="isLoading"
                        :class="['px-4 py-2 rounded-lg medieval', 
                                isLoading ? 'bg-gray-700 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600']">
                    Fight
                </button>
                <button @click="showSaveDialog" 
                        :disabled="isLoading"
                        :class="['px-4 py-2 rounded-lg medieval', 
                                isLoading ? 'bg-gray-700 cursor-not-allowed' : 'bg-green-700 hover:bg-green-600']">
                    Save Game
                </button>
                <button @click="showLoadDialog" 
                        :disabled="isLoading"
                        :class="['px-4 py-2 rounded-lg medieval', 
                                isLoading ? 'bg-gray-700 cursor-not-allowed' : 'bg-blue-700 hover:bg-blue-600']">
                    Load Game
                </button>
                <button @click="quitGame" 
                        :disabled="isLoading"
                        :class="['px-4 py-2 rounded-lg medieval', 
                                isLoading ? 'bg-gray-700 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-600']">
                    Quit
                </button>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="flex space-x-2">
                    <input v-model="userInput" 
                           @keyup.enter="sendMessage" 
                           :disabled="isLoading || diceNeeded || diceRollPending"
                           :placeholder="inputPlaceholder"
                           :class="['flex-grow px-4 py-2 rounded', 
                                  isLoading || diceNeeded || diceRollPending ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-gray-700 text-white']">
                    <button @click="sendMessage" 
                            :disabled="isLoading || diceNeeded || diceRollPending || !userInput.trim()"
                            :class="['px-6 py-2 rounded', 
                                    (isLoading || diceNeeded || diceRollPending || !userInput.trim()) ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600 text-white']">
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Save Dialog -->
        <div v-if="showingSaveDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">Save Game</h3>
                <input v-model="saveName" 
                       class="w-full bg-gray-700 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-red-500"
                       placeholder="Enter save name...">
                <div class="flex justify-end space-x-4">
                    <button @click="showingSaveDialog = false" class="px-4 py-2 rounded-lg medieval">
                        Cancel
                    </button>
                    <button @click="saveGame" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded-lg medieval">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Load Dialog -->
        <div v-if="showingLoadDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">Load Game</h3>
                <div v-if="saves.length" class="mb-4 space-y-2">
                    <div v-for="save in saves" 
                         :key="save"
                         @click="loadGame(save)"
                         class="p-2 rounded-lg cursor-pointer hover:bg-gray-700">
                        {{ save }}
                    </div>
                </div>
                <div v-else class="mb-4 text-gray-400">
                    No saves found
                </div>
                <div class="flex justify-end">
                    <button @click="showingLoadDialog = false" class="px-4 py-2 rounded-lg medieval">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback Dialog -->
        <div v-if="showFeedback" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">Feedback</h3>
                <p class="mb-4">If you found any bugs or errors, please email us at flappyfeedback@gmail.com</p>
                <div class="flex justify-end">
                    <button @click="showFeedback = false" class="px-4 py-2 rounded-lg medieval">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    gameStarted: false,
                    characterCreated: false,
                    showFeedback: false,
                    races: {},
                    classes: {},
                    selectedRace: null,
                    selectedClass: null,
                    gameState: {},
                    messages: [],
                    userInput: '',
                    showingSaveDialog: false,
                    showingLoadDialog: false,
                    saveName: '',
                    saves: [],
                    isCreatingCharacter: false,
                    diceNeeded: false,
                    diceRollPending: false,
                    diceType: null,
                    lastRoll: null,
                    isLoading: false,
                    defaultDiceType: 'd20'  // Default dice type for perception checks
                }
            },
            computed: {
                combatStatus() {
                    return this.gameState.in_combat ? 'In Combat' : 'Exploring'
                },
                inputPlaceholder() {
                    if (this.isLoading) return 'Please wait for the Dungeon Master...'
                    if (this.diceNeeded || this.diceRollPending) return 'Please roll the dice first...'
                    return 'Enter your action...'
                },
                displayDiceType() {
                    return this.diceType || this.defaultDiceType
                }
            },
            methods: {
                async startGame(language) {
                    const response = await fetch('/start_game', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ language })
                    })
                    const data = await response.json()
                    if (data.status === 'success') {
                        this.gameStarted = true
                        this.loadRacesAndClasses()
                    }
                },
                async loadRacesAndClasses() {
                    const [racesResponse, classesResponse] = await Promise.all([
                        fetch('/get_races'),
                        fetch('/get_classes')
                    ])
                    this.races = await racesResponse.json()
                    this.classes = await classesResponse.json()
                },
                selectRace(race) {
                    this.selectedRace = race
                },
                selectClass(className) {
                    this.selectedClass = className
                },
                async createCharacter() {
                    if (!this.selectedRace || !this.selectedClass || this.isCreatingCharacter) return
                    
                    this.isCreatingCharacter = true
                    try {
                        const response = await fetch('/choose_character', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                race: this.selectedRace,
                                class: this.selectedClass
                            })
                        })
                        const data = await response.json()
                        if (data.status === 'success') {
                            this.characterCreated = true
                            this.gameState = data.stats
                            this.addMessage('Welcome to your adventure!', 'system')
                            if (data.opening_scene) {
                                this.addMessage(data.opening_scene)
                            }
                        }
                    } catch (error) {
                        this.addMessage('Error creating character. Please try again.', 'system')
                    } finally {
                        this.isCreatingCharacter = false
                    }
                },
                addMessage(text, type = 'normal') {
                    this.messages.push({ text, type })
                    this.$nextTick(() => {
                        const messageBox = document.querySelector('.message-box')
                        messageBox.scrollTop = messageBox.scrollHeight
                    })
                },
                async rollDice() {
                    if (this.isLoading || (!this.diceNeeded && !this.diceRollPending)) return
                    
                    this.isLoading = true
                    try {
                        const response = await fetch('/roll_dice', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dice_type: this.displayDiceType
                            })
                        })
                        const data = await response.json()
                        
                        if (data.error) {
                            this.addMessage(data.error, 'system')
                            return
                        }
                        
                        this.lastRoll = data.roll
                        this.addMessage(`You rolled ${data.roll} on ${this.displayDiceType}`, 'user')
                        
                        if (data.message) {
                            this.addMessage(data.message, 'dm')
                        }
                        
                        // Update game state
                        this.gameState = data.stats
                        this.diceNeeded = data.dice_roll_needed || false
                        this.diceRollPending = false
                        this.diceType = data.dice_type
                        
                        // Clear input if dice roll was needed
                        if (this.diceNeeded) {
                            this.userInput = ''
                        }
                    } catch (error) {
                        this.addMessage('Error rolling dice', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                async sendMessage() {
                    if (this.isLoading || !this.userInput.trim() || this.diceNeeded || this.diceRollPending) return
                    
                    const action = this.userInput
                    this.userInput = ''
                    this.addMessage(action, 'user')
                    
                    this.isLoading = true
                    try {
                        const response = await fetch('/game_action', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action })
                        })
                        const data = await response.json()
                        
                        if (data.error) {
                            this.addMessage(`Error: ${data.error}`, 'system')
                            return
                        }
                        
                        // Update game state
                        this.gameState = data.stats
                        this.diceNeeded = data.dice_needed || false
                        this.diceType = data.dice_type
                        
                        // If dice roll is needed, set pending state
                        if (this.diceNeeded || data.required_action === 'roll_dice') {
                            this.diceRollPending = true
                        }
                        
                        // Add response message
                        if (data.response) {
                            this.addMessage(data.response, 'dm')
                        }
                        
                    } catch (error) {
                        this.addMessage('Error: Failed to send message', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                async startCombat() {
                    if (this.isLoading) return
                    
                    this.isLoading = true
                    try {
                        const response = await fetch('/combat_action', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'start' })
                        })
                        const data = await response.json()
                        this.gameState = data.stats
                        this.addMessage(data.response)
                    } catch (error) {
                        this.addMessage('Error starting combat', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                showSaveDialog() {
                    this.showingSaveDialog = true
                    this.saveName = ''
                },
                async saveGame() {
                    if (!this.saveName.trim() || this.isLoading) return

                    this.isLoading = true
                    try {
                        const response = await fetch('/save_game', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ save_name: this.saveName })
                        })
                        const data = await response.json()
                        this.addMessage(data.message, 'system')
                        this.showingSaveDialog = false
                    } catch (error) {
                        this.addMessage('Error saving game', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                async showLoadDialog() {
                    const response = await fetch('/list_saves')
                    const data = await response.json()
                    this.saves = data.saves.split('\n').filter(save => save.trim())
                    this.showingLoadDialog = true
                },
                async loadGame(saveName) {
                    if (this.isLoading) return
                    
                    this.isLoading = true
                    try {
                        const response = await fetch('/load_game', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ save_name: saveName })
                        })
                        const data = await response.json()
                        if (data.status === 'success') {
                            this.gameState = data.stats
                            this.characterCreated = true
                            this.addMessage(data.message, 'system')
                        } else {
                            this.addMessage(data.message, 'system')
                        }
                        this.showingLoadDialog = false
                    } catch (error) {
                        this.addMessage('Error loading game', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                quitGame() {
                    if (confirm('Are you sure you want to quit? Unsaved progress will be lost.')) {
                        window.location.reload()
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html> 