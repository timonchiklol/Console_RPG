<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Console Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        .medieval {
            font-family: 'MedievalSharp', cursive;
        }
        .game-bg {
            background-image: url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
        }
        .message-box {
            height: 300px;
            overflow-y: auto;
        }
        .stats-box {
            background-color: rgba(0, 0, 0, 0.7);
        }
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    {% raw %}
    <div id="app" class="container mx-auto px-4 py-8" v-cloak>
        <!-- Language Selection -->
        <div v-if="!gameStarted" class="text-center">
            <h1 class="medieval text-5xl mb-8">D&D Console Adventure</h1>
            <div class="space-x-4">
                <button @click="startGame('en')" class="bg-red-700 hover:bg-red-600 text-white px-6 py-3 rounded-lg medieval">
                    Start in English
                </button>
                <button @click="startGame('ru')" class="bg-red-700 hover:bg-red-600 text-white px-6 py-3 rounded-lg medieval">
                    Начать на Русском
                </button>
            </div>
        </div>

        <!-- Character Creation -->
        <div v-else-if="!characterCreated" class="max-w-4xl mx-auto">
            <h2 class="medieval text-3xl mb-6">Create Your Character</h2>
            
            <!-- Race Selection -->
            <div class="mb-8">
                <h3 class="medieval text-2xl mb-4">Choose Your Race</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div v-for="(stats, race) in races" 
                         :key="race"
                         @click="selectRace(race)"
                         :class="['p-4 rounded-lg cursor-pointer border-2 transition-all',
                                selectedRace === race ? 'border-red-500 bg-gray-800' : 'border-gray-700 hover:border-gray-500']">
                        <h4 class="medieval text-xl mb-2">{{ race }}</h4>
                        <p class="text-sm text-gray-400">HP: {{ stats.hp }}</p>
                        <p class="text-sm text-gray-400">Damage: {{ stats.damage }}</p>
                        <p class="text-sm text-gray-400">Gold: {{ stats.gold }}</p>
                    </div>
                </div>
            </div>

            <!-- Class Selection -->
            <div class="mb-8">
                <h3 class="medieval text-2xl mb-4">Choose Your Class</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div v-for="(stats, className) in classes" 
                         :key="className"
                         @click="selectClass(className)"
                         :class="['p-4 rounded-lg cursor-pointer border-2 transition-all',
                                selectedClass === className ? 'border-red-500 bg-gray-800' : 'border-gray-700 hover:border-gray-500']">
                        <h4 class="medieval text-xl mb-2">{{ className }}</h4>
                        <p class="text-sm text-gray-400">HP Bonus: +{{ stats.hp_bonus }}</p>
                        <p class="text-sm text-gray-400">Gold Bonus: +{{ stats.gold_bonus }}</p>
                        <p class="text-sm text-gray-400">Magic: {{ stats.magic }}</p>
                    </div>
                </div>
            </div>

            <button @click="createCharacter" 
                    :disabled="!selectedRace || !selectedClass || isCreatingCharacter"
                    :class="['w-full py-3 rounded-lg medieval text-xl transition-all',
                            (!selectedRace || !selectedClass || isCreatingCharacter) ? 'bg-gray-700 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600']">
                {{ isCreatingCharacter ? 'Creating Character...' : 'Begin Adventure' }}
            </button>
        </div>

        <!-- Game Interface -->
        <div v-else class="max-w-6xl mx-auto game-bg rounded-lg p-6">
            <!-- Character Stats -->
            <div class="stats-box rounded-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <h3 class="medieval text-xl text-red-500">Character</h3>
                    <p>{{ gameState.player_race }} {{ gameState.player_class }}</p>
                    <p>Level {{ gameState.level }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">Combat</h3>
                    <p>HP: {{ gameState.health_points }}</p>
                    <p>Damage: {{ gameState.damage }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">Resources</h3>
                    <p>Gold: {{ gameState.gold }}</p>
                    <p>Magic (1st/2nd): {{ gameState.magic_1lvl }}/{{ gameState.magic_2lvl }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">Status</h3>
                    <p>{{ combatStatus }}</p>
                    <p class="text-sm text-gray-400">{{ streamingMode ? 'Streaming' : 'Single Response' }}</p>
                </div>
            </div>

            <!-- Dice Rolling Section -->
            <div v-if="diceNeeded" class="dice-section bg-gray-800 rounded-lg p-4 mb-4">
                <h3 class="medieval text-lg mb-2">Dice Roll Required</h3>
                <p class="mb-2">Roll {{ diceType }}</p>
                <button @click="rollDice" class="bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Roll Dice
                </button>
                <p v-if="lastRoll" class="mt-2">Last roll: {{ lastRoll }}</p>
            </div>

            <!-- Game Messages -->
            <div class="message-box bg-gray-800 rounded-lg p-4 mb-4">
                <div v-for="(message, index) in messages" :key="index" class="mb-2">
                    <div v-if="message.type === 'user'" class="text-blue-400">
                        You: {{ message.text }}
                    </div>
                    <div v-else class="text-green-400">
                        DM: {{ message.text }}
                    </div>
                </div>
                <div v-if="currentStreamMessage" class="text-green-400">
                    DM: {{ currentStreamMessage.text }}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <button @click="startCombat" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded-lg medieval">
                    Fight
                </button>
                <button @click="showSaveDialog" class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg medieval">
                    Save Game
                </button>
                <button @click="showLoadDialog" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg medieval">
                    Load Game
                </button>
                <button @click="toggleStreaming" class="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded-lg medieval">
                    {{ streamingMode ? 'Disable' : 'Enable' }} Streaming
                </button>
                <button @click="quitGame" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg medieval">
                    Quit
                </button>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="flex space-x-2">
                    <input v-model="userInput" @keyup.enter="sendMessage" 
                           class="flex-grow bg-gray-700 text-white px-4 py-2 rounded"
                           placeholder="Enter your action...">
                    <button @click="sendMessage" 
                            class="bg-red-700 hover:bg-red-600 text-white px-6 py-2 rounded">
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Save Dialog -->
        <div v-if="showingSaveDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">Save Game</h3>
                <input v-model="saveName" 
                       class="w-full bg-gray-700 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-red-500"
                       placeholder="Enter save name...">
                <div class="flex justify-end space-x-4">
                    <button @click="showingSaveDialog = false" class="px-4 py-2 rounded-lg medieval">
                        Cancel
                    </button>
                    <button @click="saveGame" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded-lg medieval">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Load Dialog -->
        <div v-if="showingLoadDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">Load Game</h3>
                <div v-if="saves.length" class="mb-4 space-y-2">
                    <div v-for="save in saves" 
                         :key="save"
                         @click="loadGame(save)"
                         class="p-2 rounded-lg cursor-pointer hover:bg-gray-700">
                        {{ save }}
                    </div>
                </div>
                <div v-else class="mb-4 text-gray-400">
                    No saves found
                </div>
                <div class="flex justify-end">
                    <button @click="showingLoadDialog = false" class="px-4 py-2 rounded-lg medieval">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    gameStarted: false,
                    characterCreated: false,
                    races: {},
                    classes: {},
                    selectedRace: null,
                    selectedClass: null,
                    gameState: {},
                    messages: [],
                    userInput: '',
                    showingSaveDialog: false,
                    showingLoadDialog: false,
                    saveName: '',
                    saves: [],
                    streamingMode: true,
                    currentStreamMessage: null,
                    isCreatingCharacter: false,
                    diceNeeded: false,
                    diceType: null,
                    lastRoll: null
                }
            },
            computed: {
                combatStatus() {
                    return this.gameState.in_combat ? 'In Combat' : 'Exploring'
                }
            },
            methods: {
                async startGame(language) {
                    const response = await fetch('/start_game', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ language })
                    })
                    const data = await response.json()
                    if (data.status === 'success') {
                        this.gameStarted = true
                        this.loadRacesAndClasses()
                    }
                },
                async loadRacesAndClasses() {
                    const [racesResponse, classesResponse] = await Promise.all([
                        fetch('/get_races'),
                        fetch('/get_classes')
                    ])
                    this.races = await racesResponse.json()
                    this.classes = await classesResponse.json()
                },
                selectRace(race) {
                    this.selectedRace = race
                },
                selectClass(className) {
                    this.selectedClass = className
                },
                async createCharacter() {
                    if (!this.selectedRace || !this.selectedClass || this.isCreatingCharacter) return
                    
                    this.isCreatingCharacter = true
                    try {
                        const response = await fetch('/choose_character', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                race: this.selectedRace,
                                class: this.selectedClass
                            })
                        })
                        const data = await response.json()
                        if (data.status === 'success') {
                            this.characterCreated = true
                            this.gameState = data.stats
                            this.addMessage('Welcome to your adventure!', 'system')
                            if (data.opening_scene) {
                                this.addMessage(data.opening_scene)
                            }
                        }
                    } catch (error) {
                        this.addMessage('Error creating character. Please try again.', 'system')
                    } finally {
                        this.isCreatingCharacter = false
                    }
                },
                addMessage(text, type = 'normal') {
                    this.messages.push({ text, type })
                    this.$nextTick(() => {
                        const messageBox = document.querySelector('.message-box')
                        messageBox.scrollTop = messageBox.scrollHeight
                    })
                },
                async rollDice() {
                    const response = await fetch('/roll_dice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    const data = await response.json()
                    
                    if (data.error) {
                        this.addMessage(data.error, 'system')
                        return
                    }
                    
                    this.lastRoll = data.roll
                    this.addMessage(`You rolled ${data.roll} on ${data.dice_type}`, 'user')
                    
                    if (data.message) {
                        this.addMessage(data.message, 'dm')
                    }
                    
                    this.diceNeeded = data.dice_roll_needed || false
                    this.diceType = data.new_dice_type
                    this.gameState = data.stats
                },
                async sendMessage() {
                    if (!this.userInput.trim()) return
                    
                    const action = this.userInput
                    this.userInput = ''
                    this.addMessage(action, 'user')
                    
                    try {
                        const response = await fetch('/game_action', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action })
                        })
                        const data = await response.json()
                        console.log('Game response:', data)  // Debug log
                        
                        if (data.error) {
                            console.error('Error:', data.error)  // Debug log
                            this.addMessage(`Error: ${data.error}`, 'system')
                            return
                        }
                        
                        // Update game state
                        this.gameState = data.stats
                        this.diceNeeded = data.dice_needed
                        this.diceType = data.dice_type
                        
                        // Add response message
                        if (data.response) {
                            this.addMessage(data.response, 'dm')
                        }
                        
                        // Handle state updates
                        if (data.state_update) {
                            console.log('State update:', data.state_update)  // Debug log
                            Object.assign(this.gameState, data.state_update)
                        }
                        
                        // Handle required actions
                        if (data.required_action) {
                            console.log('Required action:', data.required_action)  // Debug log
                            // Handle specific required actions here if needed
                        }
                        
                    } catch (error) {
                        console.error('Send message error:', error)  // Debug log
                        this.addMessage('Error: Failed to send message', 'system')
                    }
                },
                async startCombat() {
                    const response = await fetch('/combat_action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'start' })
                    })
                    const data = await response.json()
                    this.gameState = data.stats
                    this.addMessage(data.response)
                },
                showSaveDialog() {
                    this.showingSaveDialog = true
                    this.saveName = ''
                },
                async saveGame() {
                    if (!this.saveName.trim()) return

                    const response = await fetch('/save_game', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ save_name: this.saveName })
                    })
                    const data = await response.json()
                    this.addMessage(data.message, 'system')
                    this.showingSaveDialog = false
                },
                async showLoadDialog() {
                    const response = await fetch('/list_saves')
                    const data = await response.json()
                    this.saves = data.saves.split('\n').filter(save => save.trim())
                    this.showingLoadDialog = true
                },
                async loadGame(saveName) {
                    const response = await fetch('/load_game', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ save_name: saveName })
                    })
                    const data = await response.json()
                    if (data.status === 'success') {
                        this.gameState = data.stats
                        this.characterCreated = true
                        this.addMessage(data.message, 'system')
                    } else {
                        this.addMessage(data.message, 'system')
                    }
                    this.showingLoadDialog = false
                },
                quitGame() {
                    if (confirm('Are you sure you want to quit? Unsaved progress will be lost.')) {
                        window.location.reload()
                    }
                },
                toggleStreaming() {
                    this.streamingMode = !this.streamingMode
                }
            }
        }).mount('#app')
    </script>
</body>
</html> 