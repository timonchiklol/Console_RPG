<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Console Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        .medieval {
            font-family: 'MedievalSharp', cursive;
        }
        .game-bg {
            background-image: url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
        }
        .message-box {
            height: 300px;
            overflow-y: auto;
        }
        .stats-box {
            background-color: rgba(0, 0, 0, 0.7);
        }
        [v-cloak] {
            display: none;
        }
        html[lang="ru"] {
            font-family: 'MedievalSharp', cursive, Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    {% raw %}
    <div id="app" class="container mx-auto px-4 py-8" v-cloak :lang="currentLanguage">
        <!-- Language Selection -->
        <div v-if="!gameStarted && !roomJoined" class="text-center">
            <h1 class="medieval text-5xl mb-8">{{ t('title') }}</h1>
            <div class="space-x-4 mb-8">
                <button @click="selectLanguage('en')" class="bg-red-700 hover:bg-red-600 text-white px-6 py-3 rounded-lg medieval">
                    Start in English
                </button>
                <button @click="selectLanguage('ru')" class="bg-red-700 hover:bg-red-600 text-white px-6 py-3 rounded-lg medieval">
                    Начать на Русском
                </button>
            </div>
        </div>

        <!-- Room Management -->
        <div v-if="languageSelected && !roomJoined" class="text-center">
            <h2 class="medieval text-3xl mb-6">{{ t('roomManagement') }}</h2>
            <!-- Player Name Input -->
            <div class="mb-4">
                <input v-model="playerName" 
                       :placeholder="t('enterPlayerName')" 
                       class="px-4 py-2 rounded-lg medieval bg-gray-700 text-white border border-gray-600 focus:border-red-500 focus:outline-none">
            </div>
            <div class="space-x-4 mb-8">
                <button @click="createRoom" 
                        :disabled="!playerName.trim()"
                        :class="['bg-green-700 hover:bg-green-600 text-white px-6 py-3 rounded-lg medieval',
                                !playerName.trim() ? 'opacity-50 cursor-not-allowed' : '']">
                    {{ t('createRoom') }}
                </button>
                <input v-model="joinRoomId" 
                       :placeholder="t('enterRoomCode')" 
                       class="px-4 py-2 rounded-lg medieval bg-gray-700 text-white border border-gray-600 focus:border-red-500 focus:outline-none">
                <button @click="joinRoom" 
                        :disabled="!playerName.trim() || !joinRoomId.trim()"
                        :class="['bg-blue-700 hover:bg-blue-600 text-white px-6 py-3 rounded-lg medieval',
                                (!playerName.trim() || !joinRoomId.trim()) ? 'opacity-50 cursor-not-allowed' : '']">
                    {{ t('joinRoom') }}
                </button>
            </div>
        </div>

        <!-- Room Info (after joining) -->
        <div v-if="roomJoined" class="bg-gray-800 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="medieval text-xl text-red-500">{{ t('roomInfo') }}</h3>
                    <p>{{ t('roomCode') }}: <span class="font-mono">{{ roomId }}</span>
                        <button @click="copyRoomCode" class="ml-2 text-sm text-blue-400 hover:text-blue-300">
                            {{ t('copyRoomCode') }}
                        </button>
                    </p>
                </div>
                <button @click="leaveRoom" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded-lg medieval">
                    {{ t('leaveRoom') }}
                </button>
            </div>
            
            <!-- Players List -->
            <div class="mt-4">
                <h4 class="medieval text-lg text-red-500 mb-2">{{ t('players') }}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="(player, id) in roomPlayers" 
                         :key="id" 
                         class="bg-gray-700 rounded-lg p-2">
                        <div class="flex items-center justify-between">
                            <span class="medieval">{{ player.name }}</span>
                            <span v-if="id === hostId" class="text-yellow-500 text-sm">{{ t('host') }}</span>
                        </div>
                        <div v-if="player.race && player.class_name" class="text-sm text-gray-400">
                            {{ player.race }} {{ player.class_name }}
                            <div>{{ t('level') }} {{ player.level }} | {{ t('hp') }}: {{ player.health_points }}</div>
                        </div>
                        <div v-else class="text-sm text-gray-400">
                            {{ t('creatingCharacter') }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Character Creation -->
        <div v-if="roomJoined && !characterCreated" class="max-w-4xl mx-auto mt-4">
            <h2 class="medieval text-3xl mb-6">{{ t('createCharacter') }}</h2>
            
            <!-- Race Selection -->
            <div class="mb-8">
                <h3 class="medieval text-2xl mb-4">{{ t('chooseRace') }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div v-for="(stats, race) in races" 
                         :key="race"
                         @click="selectRace(race)"
                         :class="['p-4 rounded-lg cursor-pointer border-2 transition-all',
                                selectedRace === race ? 'border-red-500 bg-gray-800' : 'border-gray-700 hover:border-gray-500']">
                        <h4 class="medieval text-xl mb-2">{{ race }}</h4>
                        <p class="text-sm text-gray-400">{{ t('hp') }}: {{ stats.hp }}</p>
                        <p class="text-sm text-gray-400">{{ t('damage') }}: {{ stats.damage }}</p>
                        <p class="text-sm text-gray-400">{{ t('gold') }}: {{ stats.gold }}</p>
                    </div>
                </div>
            </div>

            <!-- Class Selection -->
            <div class="mb-8">
                <h3 class="medieval text-2xl mb-4">{{ t('chooseClass') }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div v-for="(stats, className) in classes" 
                         :key="className"
                         @click="selectClass(className)"
                         :class="['p-4 rounded-lg cursor-pointer border-2 transition-all',
                                selectedClass === className ? 'border-red-500 bg-gray-800' : 'border-gray-700 hover:border-gray-500']">
                        <h4 class="medieval text-xl mb-2">{{ className }}</h4>
                        <p class="text-sm text-gray-400">{{ t('hpBonus') }}: +{{ stats.hp_bonus }}</p>
                        <p class="text-sm text-gray-400">{{ t('goldBonus') }}: +{{ stats.gold_bonus }}</p>
                        <p class="text-sm text-gray-400">{{ t('magic') }}: {{ stats.magic }}</p>
                    </div>
                </div>
            </div>

            <button @click="createCharacter" 
                    :disabled="!selectedRace || !selectedClass || isCreatingCharacter"
                    :class="['w-full py-3 rounded-lg medieval text-xl transition-all',
                            (!selectedRace || !selectedClass || isCreatingCharacter) ? 'bg-gray-700 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600']">
                {{ isCreatingCharacter ? t('creatingCharacter') : t('beginAdventure') }}
            </button>
        </div>

        <!-- Game Interface -->
        <div v-if="characterCreated" class="max-w-6xl mx-auto game-bg rounded-lg p-6 mt-4">
            <!-- Character Stats -->
            <div class="stats-box rounded-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <h3 class="medieval text-xl text-red-500">{{ t('character') }}</h3>
                    <p>{{ gameState.player_race }} {{ gameState.player_class }}</p>
                    <p>{{ t('level') }} {{ gameState.level }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">{{ t('combat') }}</h3>
                    <p>{{ t('hp') }}: {{ gameState.health_points }}</p>
                    <p>{{ t('damage') }}: {{ gameState.damage }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">{{ t('resources') }}</h3>
                    <p>{{ t('gold') }}: {{ gameState.gold }}</p>
                    <p>{{ t('magicSlots') }}: {{ gameState.magic_1lvl }}/{{ gameState.magic_2lvl }}</p>
                </div>
                <div>
                    <h3 class="medieval text-xl text-red-500">{{ t('status') }}</h3>
                    <p>{{ combatStatus }}</p>
                </div>
            </div>

            <!-- Dice Rolling Section -->
            <div v-if="diceNeeded || diceRollPending" class="dice-section bg-gray-800 rounded-lg p-4 mb-4 border-2 border-red-500 text-center">
                <h3 class="medieval text-2xl mb-4 text-red-500">⚄ {{ t('diceRollRequired') }} ⚄</h3>
                <p class="mb-4 text-xl">{{ t('dmRequestsDice').replace('{0}', displayDiceType) }}</p>
                <button @click="rollDice" 
                        :disabled="isRolling"
                        class="bg-red-700 hover:bg-red-600 text-white px-8 py-4 rounded-lg text-2xl medieval animate-pulse transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 mb-4">
                    {{ isRolling ? t('rolling') : t('roll') + ' ' + displayDiceType }}
                </button>
                <div v-if="currentRoll" class="mt-4 text-xl">
                    <span class="text-red-500 font-bold">{{ t('youRolled').replace('{0}', currentRoll) }}</span>
                </div>
            </div>

            <!-- Game Messages -->
            <div class="message-box bg-gray-800 rounded-lg p-4 mb-4">
                <div v-for="(message, index) in messages" :key="index" class="mb-2">
                    <div v-if="message.type === 'user'" class="text-blue-400">
                        {{ t('you') }}: {{ message.text }}
                    </div>
                    <div v-else-if="message.type === 'system'" class="text-yellow-400">
                        {{ t('system') }}: {{ message.text }}
                    </div>
                    <div v-else class="text-green-400">
                        {{ t('dm') }}: {{ message.text }}
                    </div>
                </div>
                <div v-if="isLoading" class="text-gray-400 animate-pulse flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    {{ t('dmThinking') }}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                <button @click="showSaveDialog" 
                        :disabled="isLoading"
                        :class="['px-4 py-2 rounded-lg medieval', 
                                isLoading ? 'bg-gray-700 cursor-not-allowed' : 'bg-green-700 hover:bg-green-600']">
                    {{ t('saveGame') }}
                </button>
                <button @click="showLoadDialog" 
                        :disabled="isLoading"
                        :class="['px-4 py-2 rounded-lg medieval', 
                                isLoading ? 'bg-gray-700 cursor-not-allowed' : 'bg-blue-700 hover:bg-blue-600']">
                    {{ t('loadGame') }}
                </button>
                <button @click="quitGame" 
                        :disabled="isLoading"
                        :class="['px-4 py-2 rounded-lg medieval', 
                                isLoading ? 'bg-gray-700 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-600']">
                    {{ t('quit') }}
                </button>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="flex space-x-2">
                    <input v-model="userInput" 
                           @keyup.enter="sendMessage" 
                           :disabled="isLoading || diceNeeded || diceRollPending"
                           :placeholder="inputPlaceholder"
                           :class="['flex-grow px-4 py-2 rounded', 
                                  isLoading || diceNeeded || diceRollPending ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-gray-700 text-white']">
                    <button @click="sendMessage" 
                            :disabled="isLoading || diceNeeded || diceRollPending || !userInput.trim()"
                            :class="['px-6 py-2 rounded', 
                                    (isLoading || diceNeeded || diceRollPending || !userInput.trim()) ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600 text-white']">
                        {{ t('send') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Save Dialog -->
        <div v-if="showingSaveDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">{{ t('saveGame') }}</h3>
                <input v-model="saveName" 
                       class="w-full bg-gray-700 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-red-500"
                       :placeholder="t('enterSaveName')">
                <div class="flex justify-end space-x-4">
                    <button @click="showingSaveDialog = false" class="px-4 py-2 rounded-lg medieval">
                        {{ t('cancel') }}
                    </button>
                    <button @click="saveGame" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded-lg medieval">
                        {{ t('save') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Load Dialog -->
        <div v-if="showingLoadDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">{{ t('loadGame') }}</h3>
                <div v-if="saves.length" class="mb-4 space-y-2">
                    <div v-for="save in saves" 
                         :key="save"
                         @click="loadGame(save)"
                         class="p-2 rounded-lg cursor-pointer hover:bg-gray-700">
                        {{ save }}
                    </div>
                </div>
                <div v-else class="mb-4 text-gray-400">
                    {{ t('noSaves') }}
                </div>
                <div class="flex justify-end">
                    <button @click="showingLoadDialog = false" class="px-4 py-2 rounded-lg medieval">
                        {{ t('close') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback Dialog -->
        <div v-if="showFeedback" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 class="medieval text-2xl mb-4">{{ t('feedback') }}</h3>
                <p class="mb-4">{{ t('feedbackText') }}</p>
                <div class="flex justify-end">
                    <button @click="showFeedback = false" class="px-4 py-2 rounded-lg medieval">
                        {{ t('close') }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    gameStarted: false,
                    roomJoined: false,
                    languageSelected: false,
                    characterCreated: false,
                    showFeedback: false,
                    races: {},
                    classes: {},
                    selectedRace: null,
                    selectedClass: null,
                    gameState: {},
                    messages: [],
                    userInput: '',
                    showingSaveDialog: false,
                    showingLoadDialog: false,
                    saveName: '',
                    saves: [],
                    isCreatingCharacter: false,
                    diceNeeded: false,
                    diceRollPending: false,
                    diceType: null,
                    lastRoll: null,
                    isLoading: false,
                    defaultDiceType: 'd20',
                    isRolling: false,
                    currentRoll: null,
                    currentLanguage: 'en',
                    playerName: '',
                    joinRoomId: '',
                    roomId: '',
                    hostId: '',
                    roomPlayers: {},
                    updateInterval: null,
                    lastMessageId: null,
                    translations: {
                        en: {
                            title: 'D&D Console Adventure',
                            roomManagement: 'Room Management',
                            createRoom: 'Create Room',
                            joinRoom: 'Join Room',
                            enterRoomCode: 'Enter Room Code',
                            createCharacter: 'Create Your Character',
                            chooseRace: 'Choose Your Race',
                            chooseClass: 'Choose Your Class',
                            hp: 'HP',
                            damage: 'Damage',
                            gold: 'Gold',
                            hpBonus: 'HP Bonus',
                            goldBonus: 'Gold Bonus',
                            magic: 'Magic',
                            creatingCharacter: 'Creating Character...',
                            beginAdventure: 'Begin Adventure',
                            character: 'Character',
                            combat: 'Combat',
                            resources: 'Resources',
                            status: 'Status',
                            level: 'Level',
                            magicSlots: 'Magic (1st/2nd)',
                            inCombat: 'In Combat',
                            exploring: 'Exploring',
                            saveGame: 'Save Game',
                            loadGame: 'Load Game',
                            quit: 'Quit',
                            enterSaveName: 'Enter save name...',
                            cancel: 'Cancel',
                            save: 'Save',
                            close: 'Close',
                            noSaves: 'No saves found',
                            feedback: 'Feedback',
                            feedbackText: 'If you found any bugs or errors, please email us at flappyfeedback@gmail.com',
                            quitConfirm: 'Are you sure you want to quit? Unsaved progress will be lost.',
                            waitingDm: 'Please wait for the Dungeon Master...',
                            rollFirst: 'Please roll the dice first...',
                            enterAction: 'Enter your action...',
                            send: 'Send',
                            diceRollRequired: 'Dice Roll Required',
                            dmRequestsDice: 'The Dungeon Master requests a {0} roll',
                            rolling: 'Rolling...',
                            roll: 'Roll',
                            youRolled: 'You rolled: {0}',
                            dmThinking: 'Dungeon Master is thinking...',
                            you: 'You',
                            system: 'System',
                            dm: 'DM',
                            enterPlayerName: 'Enter your name...',
                            roomInfo: 'Room Information',
                            roomCode: 'Room Code',
                            players: 'Players',
                            host: 'Host',
                            leaveRoom: 'Leave Room',
                            copyRoomCode: 'Copy Room Code',
                            roomCodeCopied: 'Room code copied to clipboard!',
                        },
                        ru: {
                            title: 'D&D Консольное Приключение',
                            roomManagement: 'Управление Комнатой',
                            createRoom: 'Создать Комнату',
                            joinRoom: 'Присоединиться к Комнате',
                            enterRoomCode: 'Введите Код Комнаты',
                            createCharacter: 'Создайте Своего Персонажа',
                            chooseRace: 'Выберите Расу',
                            chooseClass: 'Выберите Класс',
                            hp: 'ОЗ',
                            damage: 'Урон',
                            gold: 'Золото',
                            hpBonus: 'Бонус ОЗ',
                            goldBonus: 'Бонус Золота',
                            magic: 'Магия',
                            creatingCharacter: 'Создание Персонажа...',
                            beginAdventure: 'Начать Приключение',
                            character: 'Персонаж',
                            combat: 'Бой',
                            resources: 'Ресурсы',
                            status: 'Статус',
                            level: 'Уровень',
                            magicSlots: 'Магия (1/2 ур.)',
                            inCombat: 'В Бою',
                            exploring: 'Исследование',
                            saveGame: 'Сохранить Игру',
                            loadGame: 'Загрузить Игру',
                            quit: 'Выйти',
                            enterSaveName: 'Введите имя сохранения...',
                            cancel: 'Отмена',
                            save: 'Сохранить',
                            close: 'Закрыть',
                            noSaves: 'Сохранения не найдены',
                            feedback: 'Обратная Связь',
                            feedbackText: 'Если вы нашли ошибки или баги, пожалуйста, напишите нам на flappyfeedback@gmail.com',
                            quitConfirm: 'Вы уверены, что хотите выйти? Несохраненный прогресс будет потерян.',
                            waitingDm: 'Пожалуйста, подождите Мастера Подземелий...',
                            rollFirst: 'Пожалуйста, сначала бросьте кубик...',
                            enterAction: 'Введите ваше действие...',
                            send: 'Отправить',
                            diceRollRequired: 'Требуется Бросок Кубика',
                            dmRequestsDice: 'Мастер Подземелий просит бросить {0}',
                            rolling: 'Бросаем...',
                            roll: 'Бросить',
                            youRolled: 'Выпало: {0}',
                            dmThinking: 'Мастер Подземелий думает...',
                            you: 'Вы',
                            system: 'Система',
                            dm: 'МП',
                            enterPlayerName: 'Введите ваше имя...',
                            roomInfo: 'Информация о Комнате',
                            roomCode: 'Код Комнаты',
                            players: 'Игроки',
                            host: 'Хост',
                            leaveRoom: 'Покинуть Комнату',
                            copyRoomCode: 'Скопировать Код',
                            roomCodeCopied: 'Код комнаты скопирован!',
                        }
                    }
                }
            },
            computed: {
                combatStatus() {
                    return this.gameState.in_combat ? this.t('inCombat') : this.t('exploring')
                },
                inputPlaceholder() {
                    if (this.isLoading) return this.t('waitingDm')
                    if (this.diceNeeded || this.diceRollPending) return this.t('rollFirst')
                    return this.t('enterAction')
                },
                displayDiceType() {
                    return this.diceType || this.defaultDiceType
                }
            },
            methods: {
                t(key) {
                    return this.translations[this.currentLanguage][key] || key
                },
                selectLanguage(language) {
                    this.currentLanguage = language
                    this.languageSelected = true
                },
                async createRoom() {
                    if (!this.playerName.trim()) return
                    
                    const response = await fetch('/create_room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ player_name: this.playerName })
                    })
                    const data = await response.json()
                    if (data.status === 'success') {
                        this.roomJoined = true
                        this.roomId = data.room_id
                        this.hostId = data.player_id
                        this.startRoomUpdates()
                        this.loadRacesAndClasses()
                    }
                },
                async joinRoom() {
                    if (!this.playerName.trim() || !this.joinRoomId.trim()) return
                    
                    try {
                        const response = await fetch('/join_room', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                room_id: this.joinRoomId, 
                                player_name: this.playerName 
                            })
                        })
                        const data = await response.json()
                        if (data.status === 'success') {
                            this.roomJoined = true
                            this.roomId = data.room_id
                            this.hostId = data.host_id
                            this.roomPlayers = data.players
                            
                            // Add all existing messages
                            if (data.messages) {
                                data.messages.forEach(msg => {
                                    if (msg.type === 'system') {
                                        this.addMessage(msg.message, 'system')
                                    } else if (msg.type === 'player') {
                                        this.addMessage(`${msg.player_name}: ${msg.message}`, 'user')
                                    } else if (msg.type === 'dm') {
                                        this.addMessage(msg.message)
                                    }
                                })
                                if (data.messages.length > 0) {
                                    this.lastMessageId = data.messages[data.messages.length - 1].id
                                }
                            }
                            
                            this.startRoomUpdates()
                            this.loadRacesAndClasses()
                        } else {
                            alert(data.message)
                        }
                    } catch (error) {
                        console.error('Failed to join room:', error)
                        alert('Failed to join room. Please try again.')
                    }
                },
                async loadRacesAndClasses() {
                    try {
                        const [racesResponse, classesResponse] = await Promise.all([
                            fetch('/get_races'),
                            fetch('/get_classes')
                        ])
                        this.races = await racesResponse.json()
                        this.classes = await classesResponse.json()
                    } catch (error) {
                        console.error('Failed to load races and classes:', error)
                        this.addMessage('Error loading character options. Please try again.', 'system')
                    }
                },
                selectRace(race) {
                    this.selectedRace = race
                },
                selectClass(className) {
                    this.selectedClass = className
                },
                async createCharacter() {
                    if (!this.selectedRace || !this.selectedClass || this.isCreatingCharacter) return
                    
                    this.isCreatingCharacter = true
                    try {
                        const response = await fetch('/choose_character', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                race: this.selectedRace,
                                class: this.selectedClass
                            })
                        })
                        const data = await response.json()
                        if (data.status === 'success') {
                            this.characterCreated = true
                            this.gameState = data.player
                            this.addMessage('Welcome to your adventure!', 'system')
                            if (data.opening_scene) {
                                this.addMessage(data.opening_scene)
                            }
                        } else if (data.error) {
                            this.addMessage(`Error: ${data.error}`, 'system')
                        }
                    } catch (error) {
                        this.addMessage('Error creating character. Please try again.', 'system')
                    } finally {
                        this.isCreatingCharacter = false
                    }
                },
                addMessage(text, type = 'normal') {
                    this.messages.push({ text, type })
                    this.$nextTick(() => {
                        const messageBox = document.querySelector('.message-box')
                        messageBox.scrollTop = messageBox.scrollHeight
                    })
                },
                async rollDice() {
                    if (this.isRolling || (!this.diceNeeded && !this.diceRollPending)) return
                    
                    this.isRolling = true
                    try {
                        // First, get the immediate dice roll
                        const rollResponse = await fetch('/roll_dice', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dice_type: this.displayDiceType
                            })
                        })
                        const rollData = await rollResponse.json()
                        
                        if (rollData.error) {
                            this.addMessage(rollData.error, 'system')
                            return
                        }
                        
                        // Immediately show the roll result
                        this.currentRoll = rollData.roll
                        this.addMessage(`You rolled ${rollData.roll} on ${this.displayDiceType}`, 'user')
                        
                        // Then process the roll with Gemini
                        this.isLoading = true
                        const processResponse = await fetch('/process_roll', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                roll: rollData.roll,
                                dice_type: rollData.dice_type
                            })
                        })
                        const processData = await processResponse.json()
                        
                        if (processData.message) {
                            this.addMessage(processData.message, 'dm')
                        }
                        
                        // Update game state
                        this.gameState = processData.player
                        this.diceNeeded = processData.dice_roll_needed || false
                        this.diceRollPending = false
                        this.diceType = processData.dice_type
                        
                        // Clear input if dice roll was needed
                        if (this.diceNeeded) {
                            this.userInput = ''
                        }
                    } catch (error) {
                        this.addMessage('Error rolling dice', 'system')
                    } finally {
                        this.isRolling = false
                        this.isLoading = false
                    }
                },
                async sendMessage() {
                    if (this.isLoading || !this.userInput.trim() || this.diceNeeded || this.diceRollPending) return
                    
                    const action = this.userInput
                    this.userInput = ''
                    this.addMessage(action, 'user')
                    
                    this.isLoading = true
                    try {
                        const response = await fetch('/game_action', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action })
                        })
                        const data = await response.json()
                        
                        if (data.error) {
                            this.addMessage(`Error: ${data.error}`, 'system')
                            return
                        }
                        
                        // Update game state
                        this.gameState = data.player
                        this.diceNeeded = data.dice_needed || false
                        this.diceType = data.dice_type
                        
                        // If dice roll is needed, set pending state and reset currentRoll
                        if (this.diceNeeded || data.required_action === 'roll_dice') {
                            this.diceRollPending = true
                            this.currentRoll = null  // Reset the current roll display
                        }
                        
                        // Add response message
                        if (data.response) {
                            this.addMessage(data.response, 'dm')
                        }
                        
                    } catch (error) {
                        this.addMessage('Error: Failed to send message', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                showSaveDialog() {
                    this.showingSaveDialog = true
                    this.saveName = ''
                },
                async saveGame() {
                    if (!this.saveName.trim() || this.isLoading) return

                    this.isLoading = true
                    try {
                        const response = await fetch('/save_game', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ save_name: this.saveName })
                        })
                        const data = await response.json()
                        this.addMessage(data.message, 'system')
                        this.showingSaveDialog = false
                    } catch (error) {
                        this.addMessage('Error saving game', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                async showLoadDialog() {
                    const response = await fetch('/list_saves')
                    const data = await response.json()
                    this.saves = data.saves.split('\n').filter(save => save.trim())
                    this.showingLoadDialog = true
                },
                async loadGame(saveName) {
                    if (this.isLoading) return
                    
                    this.isLoading = true
                    try {
                        const response = await fetch('/load_game', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ save_name: saveName })
                        })
                        const data = await response.json()
                        if (data.status === 'success') {
                            this.gameState = data.player
                            this.characterCreated = true
                            this.addMessage(data.message, 'system')
                        } else {
                            this.addMessage(data.message, 'system')
                        }
                        this.showingLoadDialog = false
                    } catch (error) {
                        this.addMessage('Error loading game', 'system')
                    } finally {
                        this.isLoading = false
                    }
                },
                quitGame() {
                    if (confirm(this.t('quitConfirm'))) {
                        window.location.reload()
                    }
                },
                async leaveRoom() {
                    if (!this.roomJoined) return
                    
                    const response = await fetch('/leave_room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    const data = await response.json()
                    if (data.status === 'success') {
                        this.stopRoomUpdates()
                        this.roomJoined = false
                        this.roomId = ''
                        this.hostId = ''
                        this.roomPlayers = {}
                        this.characterCreated = false
                        this.selectedRace = null
                        this.selectedClass = null
                    }
                },
                startRoomUpdates() {
                    this.updateInterval = setInterval(this.updateRoomState, 2000)
                },
                stopRoomUpdates() {
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval)
                        this.updateInterval = null
                    }
                },
                async updateRoomState() {
                    if (!this.roomJoined) return
                    
                    try {
                        const response = await fetch(`/get_room_state${this.lastMessageId ? `?last_message_id=${this.lastMessageId}` : ''}`)
                        const data = await response.json()
                        if (data.status === 'success') {
                            this.roomPlayers = data.room.players
                            this.hostId = data.room.host_id
                            
                            // Update game state if it has changed
                            if (data.room.in_combat !== this.gameState.in_combat) {
                                this.gameState.in_combat = data.room.in_combat
                            }
                            if (data.room.enemy_health !== this.gameState.enemy_health) {
                                this.gameState.enemy_health = data.room.enemy_health
                            }
                            
                            // Add any new messages
                            if (data.messages && data.messages.length > 0) {
                                data.messages.forEach(msg => {
                                    if (msg.type === 'system') {
                                        this.addMessage(msg.message, 'system')
                                    } else if (msg.type === 'player') {
                                        this.addMessage(`${msg.player_name}: ${msg.message}`, 'user')
                                    } else if (msg.type === 'dm') {
                                        this.addMessage(msg.message)
                                    }
                                })
                                // Update last message ID
                                if (data.last_message_id) {
                                    this.lastMessageId = data.last_message_id
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Failed to update room state:', error)
                    }
                },
                copyRoomCode() {
                    navigator.clipboard.writeText(this.roomId)
                        .then(() => {
                            alert(this.t('roomCodeCopied'))
                        })
                        .catch(err => {
                            console.error('Failed to copy room code:', err)
                        })
                }
            },
            mounted() {
                // Update document language when Vue app is mounted
                document.documentElement.lang = this.currentLanguage
            },
            watch: {
                // Watch for language changes and update document language
                currentLanguage(newLang) {
                    document.documentElement.lang = newLang
                }
            },
            beforeUnmount() {
                this.stopRoomUpdates()
            }
        }).mount('#app')
    </script>
</body>
</html> 